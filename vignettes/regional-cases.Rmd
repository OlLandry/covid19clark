---
title: "Regional Map of Spread in COVID-19 cases "
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Overview
This package pulls daily data from the Johns Hopkins University [COVID-19 repository](https://github.com/CSSEGISandData/COVID-19/), and adapts code from Rami Krispin's [coronavirus](https://github.com/RamiKrispin/coronavirus) R package, which has a very nice dashboard. 

We are making a new one here to focus on specific regions, with a particular interest in Worcester, MA, so we can keep the Clark University informed about the rate of new cases in our immediate vicinity. We are also trying to leverage some of the finer spatial resolution that seems to be available in the reported cases, as opposed to just statewide totals.  We present both here though.

## Data

Get US County data and select Worcester from the `cities` database, and load in daily download of COVID-19 data
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(maps)
library(sf)
library(patchwork)

# county and state maps
counties <- st_as_sf(map(database = "county", plot = FALSE, fill = TRUE)) %>% 
  lwgeom::st_make_valid() %>% 
  mutate(state = gsub(",.*", "", ID)) %>% 
  mutate(county = gsub(".*,", "", ID)) %>% 
  dplyr::select(state, county)
states <- counties %>% group_by(state) %>% count()

# select city
city <- "Worcester"
focal_city <- world.cities %>% 
  filter(name == city & country.etc == "USA") %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326)

# COVID-19, select US cases
f <- system.file("extdata/covid19_daily.csv", package = "covid19clark")
cases <- read_csv(f) %>% filter(ctry == "US") %>% 
  st_as_sf(coords = c("x", "y"), crs = 4326) %>% 
  st_intersection(., counties) %>% 
  mutate(county = ifelse(grepl(",", admin), gsub(",.*", "", admin), NA)) %>% 
  mutate(week = lubridate::week(date)) %>%
  mutate(x = st_coordinates(.)[, 1], y = st_coordinates(.)[, 2]) %>% 
  dplyr::select(admin, ctry, county, state, x, y, week, date, cases) %>% 
  as_tibble()

# adjust for state numbers not accounted in daily county-wise totals
# sum county cases in each state by date
county_cases_tot <- cases %>% filter(!is.na(county)) %>% 
  group_by(state, county) %>% arrange(date) %>% 
  mutate(cases = cumsum(cases)) %>% ungroup %>% 
  group_by(state, date) %>% summarize(week = max(week), cases = sum(cases))

# State cases not specific to a county
state_cases_tot <- cases %>% filter(is.na(county)) %>% 
  group_by(state, date) %>% arrange(state, date) %>% ungroup() %>% 
  dplyr::select(admin, ctry, county, state, x, y, week, date, cases)

# join, and take date-wise difference between state total and county sums, 
# assign positive differences to unknown county (state centroid)
state_cnty_cases_diff <- left_join(
  county_cases_tot, state_cases_tot, by = c("state", "date", "week")
) %>% mutate(case_diff = cases.y - cases.x) %>% 
  filter(case_diff > 0) %>% 
  mutate(county = "unknown") %>% 
  rename(cases = case_diff) %>% 
  dplyr::select(admin, ctry, county, state, x, y, week, date, cases)

# combine cases
cases_adj <- cases %>% filter(!is.na(county)) %>% dplyr::select(-geometry) %>% 
  group_by(state, county) %>% arrange(date) %>% 
  mutate(cases = cumsum(cases)) %>% ungroup %>% 
  bind_rows(., state_cnty_cases_diff) %>% 
  dplyr::select(ctry, state, county, x, y, date, week, cases) %>% 
  arrange(state, county, date) %>% 
  st_as_sf(coords = c("x", "y"), crs = 4326)
```

### Massachusetts cases
Added in now. The Massachusetts DPH has county-level reporting, so we are reading these in new to replace the JHU reported data with these.  This assume they are more authoritative. **still integrating so switched off**
```{r, message=FALSE, warning=FALSE, eval=FALSE}
f <- system.file("extdata/mass_dph_cases_current.csv", package = "covid19clark")
mass_cases <- read_csv(f) %>% mutate(county = tolower(county)) %>% 
  mutate(week = lubridate::week(date))

# get centroid for mass counties 
massxy <- counties %>% 
  filter(county %in% unique(mass_cases$county)) %>% 
  filter(state == "massachusetts") %>% st_centroid() %>% 
  mutate(x = st_coordinates(.)[, 1], y = st_coordinates(.)[, 2]) %>% 
  as_tibble() %>% dplyr::select(state, county, x, y)
mass_cases_xy <- left_join(mass_cases, massxy) %>% 
  dplyr::select(state, county, x, y, week, date, cases)

# update cases
cases2 <- cases %>% 
  filter(!(date %in% unique(mass_cases$date) & state == "massachusetts")) %>% 
  dplyr::select(state, county, x, y, week, date, cases) %>% 
  mutate(county = ifelse(state == "massachusetts", 
                         tolower(gsub(" |County", "", county)), county)) %>% 
  bind_rows(., mass_cases_xy)
# cases2 %>% filter(state == "massachusetts") %>% view()

colnames(cases_adj)

mass_cases %>% filter(date == max(date)) %>% summarize(sum(cases)) %>% View()

```

### Define region
We want to examine cases within different distances from our focal city. So we'll define buffers of 1, 2, 3, and 4 degrees around Worcester (~100-400 km), and use those buffers to extract all COVID-19 case reports intersecting those. 

Here is where the data become somewhat unclear. The JHU compiled data have state data that provide no county detail, which seem centered on each state. There are also county-specific data. Totals of each county dataset in Massachusetts don't quite match the numbers provided for just states, which suggests that there are cases being reported without their county origins provided. Complicating matters, the county level data appear as single entries on dates of reporting, while state level appear to be cumulative sums. To reconcile these differences, while allowing for some county-level spatial variation to be resolved, we calculate the datewise sum across the counties (after doing a cumulative sum), and find the difference between this sum and the state-level level. Any positive difference for a given data is assigned to a county named "unknown". 

It may well be that county-level data is no longer being recorded in the source dataset, and has to be obtained from state health agencies (e.g. in Massachusetts). 
```{r, message=FALSE, warning=FALSE}
# plot(st_geometry(city_buffers))
city_buffers <- lapply(1:4, function(x) focal_city %>% st_buffer(dist = x)) %>% 
  do.call(rbind, .)
city_box <- st_bbox(city_buffers[2, ])

# extract region cases
region_cases <- lapply(1:4, function(x) {
  region_case <- st_intersection(cases_adj, city_buffers[x, ]) %>% 
    mutate(x = st_coordinates(.)[, 1], y = st_coordinates(.)[, 2]) %>% 
    dplyr::select(state, county, date, week, x, y, cases) %>% 
    filter(cases > 0)
})
```

## Plots

```{r, message=FALSE, warning=FALSE}
my_breaks <- function(x) {
  breaks <- c(min(x), median(x), max(x))
  attr(breaks,"labels") <- as.Date(breaks, origin = "1970-01-01")
  names(breaks) <- attr(breaks, "labels")
  return(breaks)
}
brks <- c(1, floor(max(region_cases[[4]]$cases) / 2), 
          max(region_cases[[4]]$cases))

# County infections, to set up size breaks
cty_casesv <- region_cases[[4]] %>% group_by(county) %>% 
  filter(date == max(date)) %>% pull(cases)
size_brks <- c(min(cty_casesv), round(mean(range(cty_casesv))), max(cty_casesv))

pal <- "RdYlBu"  # color palette
p1 <- ggplot(states) + geom_sf() + 
  geom_sf(data = focal_city, col = "black", shape = 3, size = 2) + 
  geom_point(
    data = as_tibble(
      region_cases[[4]] %>% group_by(county, state, week) %>%
        filter(county != "unknown") %>% 
        summarize(x = mean(x), y = mean(y), date = max(date), 
                  cases = max(cases)) %>% ungroup()
    ), aes(x = x, y = y, color = as.integer(date), size = cases), shape = 1
  ) + xlab("") + ylab("") + ggtitle("Cases reported by county") + 
  scale_size_continuous(limits = c(1, size_brks[3]), breaks = size_brks) + 
  scale_color_distiller(name = "Date", palette = pal, breaks = my_breaks) +
  coord_sf(xlim = city_box[c(1, 3)] + c(-0.5, 0.5), ylim = city_box[c(2, 4)]) +
  guides(color = guide_colourbar(order = 1),
         size = guide_legend(order = 2)) + 
  theme_minimal()

# State infections
state_casesv <- cases %>% 
  filter(is.na(county)) %>% group_by(state) %>% 
  filter(cases == max(cases, na.rm = TRUE)) %>% pull(cases)
size_brks <- c(ifelse(min(state_casesv) == 0, 1, min(state_casesv)),
               round(mean(range(state_casesv))),
               max(state_casesv))

# state-based regional bounding box
state_box <- states %>% 
  filter(state %in% unique(region_cases[[4]]$state)) %>% st_bbox()
p2 <- ggplot(states) + geom_sf() + 
  geom_sf(data = focal_city, col = "black", shape = 3, size = 2) + 
  geom_point(
    data = cases %>% filter(is.na(county) &!is.na(cases)) %>% 
      group_by(state, week) %>% 
      summarize(
        x = mean(x), y = mean(y), date = max(date), cases = max(cases)
      ) %>% ungroup(), 
    aes(x = x, y = y, color = as.integer(date), size = cases), shape = 1
  ) + xlab("") + ylab("") + 
  ggtitle("Cases reported by state") + 
  scale_color_distiller(name = "Date", palette = pal, breaks = my_breaks) +
  scale_size_continuous(breaks = size_brks) + 
  coord_sf(xlim = state_box[c(1, 3)] + c(-0.5, 0.5), 
           ylim = state_box[c(2, 4)]) + 
  guides(color = guide_colourbar(order = 1),
         size = guide_legend(order = 2)) + 
  theme_minimal()

# ggplot(states %>% filter(state == "massachusetts")) + geom_sf() + 
#   geom_sf(data = states %>% filter(state == "massachusetts") %>% st_centroid)

# rate plot, regional buffer
# region_cases[[1]] %>% #filter(state == "massachusetts") %>% 
#   as_tibble() %>% group_by(date) %>% 
#   summarize(cases = sum(cases)) %>% 
#   dplyr::select(date, cases) %>% View()
case_rates <- lapply(1:4, function(x) {  # x <- 4
  as_tibble(region_cases[[x]]) %>% group_by(date) %>% 
    summarize(cases = sum(cases)) %>% 
    mutate(radius = paste0("~", x, "00 km")) %>% 
    dplyr::select(radius, date, cases)
}) %>% do.call(rbind, .)

ylimit <- max(c(case_rates$cases, 
                cases %>% filter(is.na(county)) %>% pull(cases)))
p3 <- ggplot(case_rates) + 
  geom_line(aes(x = date, y = cases, color = radius)) +
  ylim(0, ylimit) + 
  ggtitle("Cases within varying distances") + 
  geom_line(aes(date, cases, color = radius)) + 
  scale_color_brewer(name = "", palette = pal) + theme_minimal()

# rate plot, all states in 4 degree radius
# cases %>% filter(state == "Massachusetts") %>% 
#   filter(date > lubridate::ymd("2020-03-01"))
p4 <- cases %>% filter(is.na(county)) %>% 
  filter(state %in% unique(region_cases[[2]]$state)) %>% 
  filter(date > lubridate::ymd("2020-03-01")) %>% 
  ggplot() + geom_line(aes(date, cases, color = state)) +
  ylim(0, ylimit) + 
  xlab("") + ylab("Cases") + 
  ggtitle("Cases per state") + 
  scale_color_brewer(name = "", palette = pal) + theme_minimal()

op <- (p1 + p2) / (p3 + p4)
f <- here::here("vignettes/figures/case_maps.png")
ggsave(op, filename = f, height = 7, width = 10, dpi = 300)
```

```{r, echo=FALSE, out.width='100%'}
knitr::include_graphics(f)
```

